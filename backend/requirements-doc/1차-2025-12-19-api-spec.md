# Feature Specification: SSH Monitor MVP - API 명세

## 1. 요구사항 요약

SSH Monitor 1차 개발(MVP)의 백엔드 API를 구현합니다. 단일 SSH 연결 및 터미널 통신을 지원하며, 클라이언트에서 전달받은 SSH 연결 정보를 사용하여 실시간 터미널 세션을 제공합니다.

**핵심 원칙:**
- SSH 연결 정보는 서버에 저장하지 않음 (클라이언트 LocalStorage 전용)
- WebSocket을 통한 실시간 터미널 I/O 처리
- 상태 비저장(Stateless) REST API 설계

**SSH 라이브러리:**
- Apache MINA SSHD 2.x 사용 (활발한 유지보수, 비동기 I/O 지원)

---

## 2. API 명세 (Backend)

### 2.1 REST Endpoints

#### 2.1.1 연결 상태 확인

- **Method**: POST
- **URL**: `/api/connections/validate`
- **Purpose**: 클라이언트에서 전달한 SSH 연결 정보의 유효성을 검증

**Request Body:**
```typescript
{
  "host": string;        // SSH 서버 주소 (IP 또는 도메인)
  "port": number;        // SSH 포트 (기본값: 22)
  "username": string;    // SSH 사용자명
  "authType": "password" | "privateKey";  // 인증 방식
  "password"?: string;   // 패스워드 인증 시 필수
  "privateKey"?: string; // 키 인증 시 필수 (PEM 포맷)
}
```

**Success Response (200 OK):**
```typescript
{
  "valid": true,
  "message": "Connection successful",
  "serverInfo": {
    "hostname": string;
    "osType": string;     // Linux, Unix, etc.
    "serverTime": string; // ISO 8601 format
  }
}
```

**Error Response (400 Bad Request):**
```typescript
{
  "valid": false,
  "message": string,  // "Authentication failed", "Connection timeout", etc.
  "errorCode": string // "AUTH_FAILED", "TIMEOUT", "NETWORK_ERROR"
}
```

**Implementation Notes:**
- Apache MINA SSHD를 사용하여 SSH 연결 테스트
- 연결 정보는 메모리에서만 처리하고 절대 저장하지 않음
- 타임아웃: 10초 설정
- 연결 성공 시 즉시 세션 종료 (WebSocket 연결 시 재생성)

---

#### 2.1.2 서버 시스템 정보 조회

- **Method**: POST
- **URL**: `/api/connections/info`
- **Purpose**: SSH 연결 후 서버의 기본 시스템 정보를 조회

**Request Body:**
```typescript
{
  "host": string;
  "port": number;
  "username": string;
  "authType": "password" | "privateKey";
  "password"?: string;
  "privateKey"?: string;
}
```

**Success Response (200 OK):**
```typescript
{
  "hostname": string;
  "osType": string;
  "osVersion": string;
  "uptime": string;
  "cpuCores": number;
  "memoryTotal": string;  // "8GB" 형식
  "diskUsage": string;    // "45%" 형식
}
```

**Error Response (400 Bad Request):**
```typescript
{
  "error": string,
  "errorCode": string
}
```

**Implementation Notes:**
- 다음 명령어를 실행하여 정보 수집:
  - `hostname`
  - `uname -a`
  - `uptime`
  - `nproc`
  - `free -h`
  - `df -h`
- 명령어 실행 타임아웃: 5초
- 명령어 실행 실패 시 해당 필드는 "N/A" 반환

---

### 2.2 WebSocket Channels

#### 2.2.1 터미널 세션 WebSocket

- **URL**: `/ws/terminal`
- **Purpose**: 실시간 SSH 터미널 I/O 통신
- **Protocol**: STOMP over WebSocket

**Connection Flow:**
```
1. Client → Server: CONNECT with connection info
2. Server → Client: CONNECTED (세션 ID 포함)
3. Client ↔ Server: 터미널 I/O 메시지 교환
4. Client → Server: DISCONNECT
```

**Message Types:**

##### 1) Client → Server: Connect Message

**Topic**: `/app/terminal/connect`

**Payload:**
```typescript
{
  "sessionId": string;   // 클라이언트 생성 UUID
  "host": string;
  "port": number;
  "username": string;
  "authType": "password" | "privateKey";
  "password"?: string;
  "privateKey"?: string;
  "terminalConfig": {
    "cols": number;      // 터미널 컬럼 수 (기본값: 80)
    "rows": number;      // 터미널 행 수 (기본값: 24)
    "term": string;      // 터미널 타입 (기본값: "xterm-256color")
  }
}
```

**Server Response:**
```typescript
{
  "type": "connected",
  "sessionId": string,
  "message": "SSH connection established"
}
```

**Error Response:**
```typescript
{
  "type": "error",
  "sessionId": string,
  "errorCode": string,
  "message": string
}
```

---

##### 2) Client → Server: Input Message

**Topic**: `/app/terminal/input`

**Payload:**
```typescript
{
  "sessionId": string,
  "data": string  // 사용자 입력 (키 입력, Ctrl+C 등)
}
```

---

##### 3) Server → Client: Output Message

**Subscription**: `/topic/terminal/{sessionId}`

**Payload:**
```typescript
{
  "type": "output",
  "sessionId": string,
  "data": string  // SSH 서버로부터의 출력 (stdout/stderr)
}
```

---

##### 4) Server → Client: Status Message

**Subscription**: `/topic/terminal/{sessionId}`

**Payload:**
```typescript
{
  "type": "status",
  "sessionId": string,
  "status": "connected" | "disconnected" | "error",
  "message"?: string
}
```

---

##### 5) Client → Server: Disconnect Message

**Topic**: `/app/terminal/disconnect`

**Payload:**
```typescript
{
  "sessionId": string
}
```

**Server Response:**
```typescript
{
  "type": "disconnected",
  "sessionId": string,
  "message": "SSH session closed"
}
```

---

##### 6) Client → Server: Resize Terminal

**Topic**: `/app/terminal/resize`

**Payload:**
```typescript
{
  "sessionId": string,
  "cols": number,
  "rows": number
}
```

**Server Response:**
```typescript
{
  "type": "resized",
  "sessionId": string,
  "cols": number,
  "rows": number
}
```

---

**Connection Lifecycle:**

1. **Connect Phase**
   - 클라이언트가 WebSocket 연결 후 `/app/terminal/connect` 메시지 전송
   - 서버는 Apache MINA SSHD를 사용하여 SSH 세션 생성
   - PTY(Pseudo Terminal) 할당 및 쉘 시작
   - 세션 ID를 키로 세션 맵에 저장

2. **Active Phase**
   - 클라이언트 입력 → `/app/terminal/input` → SSH 서버로 전송
   - SSH 서버 출력 → `/topic/terminal/{sessionId}` → 클라이언트로 전송
   - 비동기 I/O 처리 (별도 스레드)

3. **Disconnect Phase**
   - 클라이언트가 `/app/terminal/disconnect` 전송
   - 또는 WebSocket 연결 종료 감지
   - SSH 세션 정리 및 메모리에서 제거

**Error Handling:**
- 인증 실패: `errorCode: "AUTH_FAILED"`
- 연결 타임아웃: `errorCode: "TIMEOUT"`
- 네트워크 오류: `errorCode: "NETWORK_ERROR"`
- 세션 만료: `errorCode: "SESSION_EXPIRED"`

**Implementation Notes:**
- 세션 타임아웃: 30분 (비활성 시)
- 최대 동시 세션 수: 10개 (MVP 제한)
- 출력 버퍼 크기: 8KB
- Apache MINA SSHD ChannelShell 사용 (Interactive Shell)
- UTF-8 인코딩 사용

---

### 2.3 DTO/Model 정의

#### 2.3.1 SshConnectionRequest

```java
package com.sshmonitor.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.Max;

public record SshConnectionRequest(
    @NotBlank(message = "Host is required")
    String host,

    @Min(1)
    @Max(65535)
    Integer port,

    @NotBlank(message = "Username is required")
    String username,

    @NotBlank(message = "Auth type is required")
    String authType,  // "password" or "privateKey"

    String password,

    String privateKey
) {
    public SshConnectionRequest {
        if (port == null) {
            port = 22;
        }

        if ("password".equals(authType) && (password == null || password.isBlank())) {
            throw new IllegalArgumentException("Password is required for password authentication");
        }

        if ("privateKey".equals(authType) && (privateKey == null || privateKey.isBlank())) {
            throw new IllegalArgumentException("Private key is required for key authentication");
        }
    }
}
```

---

#### 2.3.2 ConnectionValidationResponse

```java
package com.sshmonitor.dto;

public record ConnectionValidationResponse(
    Boolean valid,
    String message,
    ServerInfo serverInfo,
    String errorCode
) {
    public record ServerInfo(
        String hostname,
        String osType,
        String serverTime
    ) {}

    // Success response factory
    public static ConnectionValidationResponse success(ServerInfo serverInfo) {
        return new ConnectionValidationResponse(
            true,
            "Connection successful",
            serverInfo,
            null
        );
    }

    // Error response factory
    public static ConnectionValidationResponse error(String message, String errorCode) {
        return new ConnectionValidationResponse(
            false,
            message,
            null,
            errorCode
        );
    }
}
```

---

#### 2.3.3 ServerInfoResponse

```java
package com.sshmonitor.dto;

public record ServerInfoResponse(
    String hostname,
    String osType,
    String osVersion,
    String uptime,
    Integer cpuCores,
    String memoryTotal,
    String diskUsage
) {}
```

---

#### 2.3.4 TerminalMessage

```java
package com.sshmonitor.dto;

public record TerminalMessage(
    String type,        // "connected", "output", "status", "error", "disconnected", "resized"
    String sessionId,
    String data,        // For output/input
    String status,      // For status messages
    String message,     // For informational messages
    String errorCode,   // For error messages
    Integer cols,       // For resize
    Integer rows        // For resize
) {
    // Factory methods for different message types
    public static TerminalMessage connected(String sessionId) {
        return new TerminalMessage(
            "connected",
            sessionId,
            null,
            null,
            "SSH connection established",
            null,
            null,
            null
        );
    }

    public static TerminalMessage output(String sessionId, String data) {
        return new TerminalMessage(
            "output",
            sessionId,
            data,
            null,
            null,
            null,
            null,
            null
        );
    }

    public static TerminalMessage error(String sessionId, String errorCode, String message) {
        return new TerminalMessage(
            "error",
            sessionId,
            null,
            null,
            message,
            errorCode,
            null,
            null
        );
    }

    public static TerminalMessage disconnected(String sessionId) {
        return new TerminalMessage(
            "disconnected",
            sessionId,
            null,
            null,
            "SSH session closed",
            null,
            null,
            null
        );
    }

    public static TerminalMessage resized(String sessionId, Integer cols, Integer rows) {
        return new TerminalMessage(
            "resized",
            sessionId,
            null,
            null,
            null,
            null,
            cols,
            rows
        );
    }

    public static TerminalMessage status(String sessionId, String status, String message) {
        return new TerminalMessage(
            "status",
            sessionId,
            null,
            status,
            message,
            null,
            null,
            null
        );
    }
}
```

---

#### 2.3.5 TerminalConnectRequest

```java
package com.sshmonitor.dto;

import jakarta.validation.constraints.NotBlank;

public record TerminalConnectRequest(
    @NotBlank
    String sessionId,

    @NotBlank
    String host,

    Integer port,

    @NotBlank
    String username,

    @NotBlank
    String authType,

    String password,

    String privateKey,

    TerminalConfig terminalConfig
) {
    public record TerminalConfig(
        Integer cols,
        Integer rows,
        String term
    ) {
        public TerminalConfig {
            if (cols == null) cols = 80;
            if (rows == null) rows = 24;
            if (term == null || term.isBlank()) term = "xterm-256color";
        }
    }

    public TerminalConnectRequest {
        if (port == null) port = 22;
    }
}
```

---

#### 2.3.6 TerminalInputRequest

```java
package com.sshmonitor.dto;

import jakarta.validation.constraints.NotBlank;

public record TerminalInputRequest(
    @NotBlank
    String sessionId,

    @NotBlank
    String data
) {}
```

---

#### 2.3.7 TerminalDisconnectRequest

```java
package com.sshmonitor.dto;

import jakarta.validation.constraints.NotBlank;

public record TerminalDisconnectRequest(
    @NotBlank
    String sessionId
) {}
```

---

#### 2.3.8 TerminalResizeRequest

```java
package com.sshmonitor.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Min;

public record TerminalResizeRequest(
    @NotBlank
    String sessionId,

    @Min(1)
    Integer cols,

    @Min(1)
    Integer rows
) {}
```

---

## 3. 서비스 레이어 설계

### 3.1 SshConnectionService

**역할:** SSH 연결 생성, 유효성 검증, 시스템 정보 조회

**주요 메서드:**

```java
public interface SshConnectionService {
    /**
     * SSH 연결 정보 유효성 검증
     */
    ConnectionValidationResponse validateConnection(SshConnectionRequest request);

    /**
     * SSH 연결을 통한 서버 정보 조회
     */
    ServerInfoResponse getServerInfo(SshConnectionRequest request);

    /**
     * Apache MINA SSHD ClientSession 생성 (내부 헬퍼)
     */
    ClientSession createSession(SshConnectionRequest request) throws IOException;

    /**
     * SSH 명령 실행 (내부 헬퍼)
     */
    String executeCommand(ClientSession session, String command, int timeoutSeconds) throws Exception;
}
```

**구현 포인트:**
- Apache MINA SSHD 라이브러리 사용
- AcceptAllServerKeyVerifier 사용 (MVP에서는 검증 생략)
- 연결 타임아웃: 10초
- 명령 실행 타임아웃: 5초
- 예외 처리: IOException, SshException 등을 catch하여 적절한 에러 코드로 변환

---

### 3.2 TerminalSessionService

**역할:** WebSocket 터미널 세션 관리

**주요 메서드:**

```java
public interface TerminalSessionService {
    /**
     * 새로운 터미널 세션 생성
     */
    TerminalMessage connect(TerminalConnectRequest request);

    /**
     * 터미널 입력 처리
     */
    void handleInput(TerminalInputRequest request);

    /**
     * 터미널 세션 종료
     */
    TerminalMessage disconnect(TerminalDisconnectRequest request);

    /**
     * 터미널 크기 조정
     */
    TerminalMessage resize(TerminalResizeRequest request);

    /**
     * 세션 출력 데이터 읽기 (비동기 처리)
     */
    void startOutputReader(String sessionId);

    /**
     * 세션 정리 (타임아웃 또는 에러 시)
     */
    void cleanupSession(String sessionId);
}
```

**세션 관리 구조:**

```java
// 세션 상태 관리 (메모리)
private final ConcurrentHashMap<String, TerminalSession> sessions = new ConcurrentHashMap<>();

// TerminalSession 내부 클래스
private static class TerminalSession {
    private final String sessionId;
    private final SshClient sshClient;           // Apache MINA SSHD Client
    private final ClientSession clientSession;   // Apache MINA SSHD Session
    private final ChannelShell channelShell;     // Apache MINA SSHD ChannelShell
    private final PipedInputStream pipedIn;
    private final PipedOutputStream pipedOut;
    private final Thread outputReaderThread;
    private final Instant createdAt;
    private Instant lastActivityAt;
}
```

**구현 포인트:**
- 세션별 독립적인 입출력 스트림 관리
- 비동기 출력 읽기: 별도 스레드에서 InputStream을 읽어 WebSocket으로 전송
- 세션 타임아웃: ScheduledExecutorService로 30분 비활성 세션 정리
- 동시 세션 제한: MVP에서는 10개로 제한
- 스레드 안전성: ConcurrentHashMap 사용

---

### 3.3 WebSocket Configuration

**WebSocketConfig.java**

```java
package com.sshmonitor.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic");
        config.setApplicationDestinationPrefixes("/app");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws/terminal")
                .setAllowedOrigins("*")  // MVP에서는 모든 origin 허용
                .withSockJS();
    }
}
```

---

## 4. 데이터 흐름

### 4.1 연결 검증 플로우

```
Client                    API                    Service                  SSH Server
  |                        |                       |                          |
  |-- POST /validate ----->|                       |                          |
  |                        |-- validate() -------->|                          |
  |                        |                       |-- SshClient.connect() -->|
  |                        |                       |<----- session OK --------|
  |                        |<-- ValidationResp ----|                          |
  |<---- 200 OK -----------|                       |                          |
  |                        |                       |-- session.close() ------>|
```

---

### 4.2 터미널 세션 플로우

```
Client                  WebSocket                Service                  SSH Server
  |                        |                       |                          |
  |-- WS Connect --------->|                       |                          |
  |<-- WS Connected -------|                       |                          |
  |                        |                       |                          |
  |-- /app/terminal/connect ->|                    |                          |
  |                        |-- connect() --------->|                          |
  |                        |                       |-- SshClient.connect() -->|
  |                        |                       |-- channelShell.open() -->|
  |                        |                       |-- startOutputReader() -->|
  |                        |<-- TerminalMsg -------|                          |
  |<-- /topic/{id} --------|                       |                          |
  |                        |                       |                          |
  |-- /app/terminal/input ->|                      |                          |
  |                        |-- handleInput() ----->|                          |
  |                        |                       |-- pipedOut.write() ----->|
  |                        |                       |<-- pipedIn.read() -------|
  |                        |<-- TerminalMsg -------|                          |
  |<-- /topic/{id} --------|                       |                          |
  |                        |                       |                          |
  |(계속적인 I/O 반복)                                                           |
  |                        |                       |                          |
  |-- /app/terminal/disconnect ->|                 |                          |
  |                        |-- disconnect() ------>|                          |
  |                        |                       |-- cleanupSession() ----->|
  |                        |<-- TerminalMsg -------|                          |
  |<-- /topic/{id} --------|                       |                          |
  |-- WS Disconnect ------>|                       |                          |
```

---

### 4.3 에러 처리 플로우

```
Client                  API/WebSocket            Service                  SSH Server
  |                        |                       |                          |
  |-- Request ------------>|                       |                          |
  |                        |-- process() --------->|                          |
  |                        |                       |-- connect() ------------>|
  |                        |                       |<-- Exception ------------|
  |                        |<-- Error Response ----|                          |
  |<-- Error Message ------|                       |                          |
  |                        |                       |-- cleanupSession() ------|
```

**에러 코드 정의:**

| Error Code | Description | HTTP Status / WS Response |
|------------|-------------|---------------------------|
| AUTH_FAILED | 인증 실패 | 400 / error message |
| TIMEOUT | 연결 타임아웃 | 408 / error message |
| NETWORK_ERROR | 네트워크 오류 | 503 / error message |
| SESSION_EXPIRED | 세션 만료 | 410 / error message |
| INVALID_REQUEST | 잘못된 요청 | 400 / error message |
| SESSION_LIMIT | 세션 수 초과 | 429 / error message |
| COMMAND_FAILED | 명령 실행 실패 | 500 / error message |

---

## 5. 구현 체크리스트

### Backend

#### 5.1 환경 설정
- [ ] Spring Boot 프로젝트 생성 (Java 21, Spring Boot 3.2.14+)
- [ ] Apache MINA SSHD 의존성 추가 (`org.apache.sshd:sshd-core:2.13.0`)
- [ ] WebSocket 의존성 추가 (`spring-boot-starter-websocket`)
- [ ] Validation 의존성 추가 (`spring-boot-starter-validation`)
- [ ] Lombok 설정

#### 5.2 Configuration
- [ ] WebSocketConfig 클래스 구현
- [ ] CORS 설정 (모든 origin 허용 - MVP)
- [ ] STOMP 메시지 브로커 설정 (/topic, /app)
- [ ] StompEndpoint 등록 (/ws/terminal)

#### 5.3 DTO 클래스
- [ ] SshConnectionRequest 레코드
- [ ] ConnectionValidationResponse 레코드
- [ ] ServerInfoResponse 레코드
- [ ] TerminalMessage 레코드 (factory methods 포함)
- [ ] TerminalConnectRequest 레코드
- [ ] TerminalInputRequest 레코드
- [ ] TerminalDisconnectRequest 레코드
- [ ] TerminalResizeRequest 레코드

#### 5.4 Service Layer
- [ ] SshConnectionService 인터페이스 및 구현체
  - [ ] validateConnection() 메서드
  - [ ] getServerInfo() 메서드
  - [ ] createSession() 헬퍼 메서드
  - [ ] executeCommand() 헬퍼 메서드
- [ ] TerminalSessionService 인터페이스 및 구현체
  - [ ] connect() 메서드
  - [ ] handleInput() 메서드
  - [ ] disconnect() 메서드
  - [ ] resize() 메서드
  - [ ] startOutputReader() 메서드 (비동기)
  - [ ] cleanupSession() 메서드
  - [ ] 세션 타임아웃 관리 (ScheduledExecutorService)

#### 5.5 Controller Layer
- [ ] ConnectionController (REST)
  - [ ] POST /api/connections/validate
  - [ ] POST /api/connections/info
  - [ ] 예외 처리 (@ExceptionHandler)
- [ ] TerminalWebSocketController
  - [ ] @MessageMapping("/terminal/connect")
  - [ ] @MessageMapping("/terminal/input")
  - [ ] @MessageMapping("/terminal/disconnect")
  - [ ] @MessageMapping("/terminal/resize")
  - [ ] 세션별 @SendTo("/topic/terminal/{sessionId}")

#### 5.6 에러 처리
- [ ] GlobalExceptionHandler 클래스
- [ ] 커스텀 예외 클래스 (SshConnectionException, TerminalSessionException)
- [ ] 에러 코드 enum 정의
- [ ] 에러 응답 DTO

#### 5.7 보안 및 제약
- [ ] SSH 연결 정보 메모리 전용 처리 (절대 저장 금지)
- [ ] 세션 수 제한 (10개) 구현
- [ ] 타임아웃 설정 (연결: 10초, 명령: 5초, 세션: 30분)
- [ ] 입력 validation (@Valid 어노테이션)

#### 5.8 테스트
- [ ] ConnectionController 단위 테스트
- [ ] SshConnectionService 단위 테스트
- [ ] TerminalSessionService 단위 테스트
- [ ] WebSocket 통합 테스트 (선택사항 - MVP)

---

## 6. 참고사항

### 6.1 보안 고려사항

1. **연결 정보 관리**
   - SSH 연결 정보는 절대 서버 디스크나 데이터베이스에 저장하지 않음
   - 메모리에서만 처리하며, 세션 종료 시 즉시 제거

2. **세션 관리**
   - 세션 ID는 클라이언트가 UUID로 생성하여 전달
   - 세션 맵은 ConcurrentHashMap으로 스레드 안전성 보장
   - 비활성 세션 자동 정리 (30분)

3. **입력 검증**
   - 모든 DTO에 @Valid 어노테이션 적용
   - Host, Port, Username, AuthType 필수값 검증
   - Password/PrivateKey 조건부 검증

### 6.2 성능 고려사항

1. **비동기 처리**
   - SSH 출력은 별도 스레드에서 읽어 WebSocket으로 전송
   - ScheduledExecutorService로 세션 타임아웃 관리

2. **리소스 관리**
   - 세션 종료 시 모든 리소스 정리 (SshClient, ClientSession, ChannelShell, Stream, Thread)
   - 최대 동시 세션 수 제한으로 메모리 사용량 제어

3. **버퍼 크기**
   - 출력 버퍼: 8KB
   - 입력은 즉시 전송 (버퍼링 없음)

### 6.3 에러 처리 전략

1. **연결 실패**
   - 인증 오류: AUTH_FAILED
   - 타임아웃: TIMEOUT
   - 네트워크 오류: NETWORK_ERROR

2. **세션 오류**
   - 세션 만료: SESSION_EXPIRED
   - 세션 수 초과: SESSION_LIMIT
   - 명령 실행 실패: COMMAND_FAILED

3. **복구 전략**
   - 일시적 네트워크 오류: 클라이언트에서 재시도
   - 인증 오류: 사용자에게 연결 정보 재확인 요청
   - 세션 만료: 새로운 세션 생성 필요

### 6.4 MVP 제약사항

1. **기능 제한**
   - 동시 세션: 최대 10개
   - SSH 키 인증: PEM 포맷만 지원
   - HostKeyVerifier: AcceptAll (known_hosts 검증 생략)

2. **향후 개선사항**
   - SSH 키 형식 확장 (OpenSSH, PPK 등)
   - 세션 재연결 기능
   - 명령 히스토리 저장
   - 멀티 세션 관리 (2차 개발)

### 6.5 Apache MINA SSHD 설정 예시

```java
import org.apache.sshd.client.SshClient;
import org.apache.sshd.client.channel.ChannelShell;
import org.apache.sshd.client.session.ClientSession;
import org.apache.sshd.common.channel.PtyChannelConfiguration;
import org.apache.sshd.client.keyverifier.AcceptAllServerKeyVerifier;

import java.io.PipedInputStream;
import java.io.PipedOutputStream;
import java.security.KeyPair;
import java.time.Duration;

// SshClient 생성 (애플리케이션 시작 시 한 번만 생성)
SshClient sshClient = SshClient.setUpDefaultClient();
sshClient.setServerKeyVerifier(AcceptAllServerKeyVerifier.INSTANCE);
sshClient.start();

// ClientSession 생성
ClientSession session = sshClient.connect(username, host, port)
    .verify(Duration.ofSeconds(10))
    .getSession();

// 인증 설정
if ("password".equals(authType)) {
    session.addPasswordIdentity(password);
} else if ("privateKey".equals(authType)) {
    // PEM 형식 키 파싱
    KeyPair keyPair = loadKeyPair(privateKey);
    session.addPublicKeyIdentity(keyPair);
}

// 인증 수행
session.auth().verify(Duration.ofSeconds(10));

// ChannelShell 생성
ChannelShell channel = session.createShellChannel();

// PTY 설정
PtyChannelConfiguration ptyConfig = new PtyChannelConfiguration();
ptyConfig.setPtyType(termType);      // "xterm-256color"
ptyConfig.setPtyColumns(cols);        // 80
ptyConfig.setPtyLines(rows);          // 24
channel.setPtyChannelConfiguration(ptyConfig);

// 스트림 설정
PipedOutputStream userInput = new PipedOutputStream();
PipedInputStream channelIn = new PipedInputStream(userInput);
channel.setIn(channelIn);

PipedInputStream userOutput = new PipedInputStream();
PipedOutputStream channelOut = new PipedOutputStream(userOutput);
channel.setOut(channelOut);
channel.setErr(channelOut);  // stderr도 같은 스트림으로

// 채널 열기
channel.open().verify(Duration.ofSeconds(10));

// 사용자 입력 쓰기
userInput.write("ls -la\n".getBytes());
userInput.flush();

// 출력 읽기 (별도 스레드에서)
byte[] buffer = new byte[8192];
int read;
while ((read = userOutput.read(buffer)) != -1) {
    String output = new String(buffer, 0, read, StandardCharsets.UTF_8);
    // WebSocket으로 전송
}

// 정리
channel.close();
session.close();
```

### 6.6 의존성 (build.gradle)

```gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-validation'

    // Apache MINA SSHD
    implementation 'org.apache.sshd:sshd-core:2.13.0'

    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}
```

---

## 7. 패키지 구조

```
com.sshmonitor
├── config
│   ├── WebSocketConfig.java
│   └── SshClientConfig.java        // SshClient Bean 설정
├── controller
│   ├── ConnectionController.java
│   ├── TerminalWebSocketController.java
│   └── GlobalExceptionHandler.java
├── service
│   ├── SshConnectionService.java
│   ├── SshConnectionServiceImpl.java
│   ├── TerminalSessionService.java
│   └── TerminalSessionServiceImpl.java
├── dto
│   ├── SshConnectionRequest.java
│   ├── ConnectionValidationResponse.java
│   ├── ServerInfoResponse.java
│   ├── TerminalMessage.java
│   ├── TerminalConnectRequest.java
│   ├── TerminalInputRequest.java
│   ├── TerminalDisconnectRequest.java
│   └── TerminalResizeRequest.java
├── exception
│   ├── SshConnectionException.java
│   ├── TerminalSessionException.java
│   └── ErrorCode.java (enum)
└── SshMonitorApplication.java
```

---

**작성일:** 2025-12-19
**버전:** 1.0 (MVP)
**담당:** Backend Team
**변경이력:** JSch → Apache MINA SSHD 2.x 변경
